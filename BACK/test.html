<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Prueba Completa API Trirule</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1000px;
      margin: 0 auto;
      padding: 20px;
    }
    section {
      border: 1px solid #ddd;
      border-radius: 5px;
      padding: 15px;
      margin-bottom: 20px;
    }
    h2 {
      color: #2c3e50;
      border-bottom: 1px solid #eee;
      padding-bottom: 10px;
    }
    pre {
      background: #f5f5f5;
      padding: 10px;
      border-radius: 3px;
      overflow-x: auto;
    }
    input, select, button {
      padding: 8px;
      margin: 5px 0;
    }
    button {
      background: #3498db;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
    }
    button:hover {
      background: #2980b9;
    }
    .form-group {
      margin-bottom: 10px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    .success {
      color: #27ae60;
    }
    .error {
      color: #e74c3c;
    }
  </style>
</head>
<body>
  <h1>Prueba Completa API Trirule</h1>
  
  <!-- Sección de Autenticación -->
  <section id="auth-section">
    <h2>Autenticación</h2>
  
    <div class="form-group">
      <label for="email">Email:</label>
      <input type="email" id="email" placeholder="test@example.com" value="test@example.com" />
    </div>
  
    <div class="form-group">
      <label for="password">Contraseña:</label>
      <input type="password" id="password" placeholder="hashedpassword" value="hashedpassword" />
    </div>
  
    <button onclick="login()">Login</button>
    <button onclick="checkAuth()">Verificar Autenticación</button>
    <button onclick="logout()">Logout</button>
    <button onclick="getProfile()">Obtener Perfil</button>
  
    <hr />
  
    <div class="form-group">
      <label for="checkEmail">Verificar Email:</label>
      <input type="email" id="checkEmail" placeholder="nuevo@example.com" />
      <button onclick="checkEmail()">Comprobar Email</button>
    </div>
  
    <div class="form-group">
      <label for="checkUsername">Verificar Usuario:</label>
      <input type="text" id="checkUsername" placeholder="nombre_usuario" />
      <button onclick="checkUsername()">Comprobar Usuario</button>
    </div>
  
    <div class="form-group">
      <label>Resultado:</label>
      <pre id="authResult"></pre>
    </div>
  </section>  

  <!-- Sección de Configuración de Usuario -->
  <section id="settings-section">
    <h2>Configuración de Usuario</h2>
    
    <div class="form-group">
      <label for="currency">Moneda:</label>
      <input type="text" id="currency" placeholder="EUR" />
    </div>
    
    <button onclick="getSettings()">Obtener Configuración</button>
    <button onclick="updateSettings()">Actualizar Configuración</button>
    
    <div class="form-group">
      <label>Resultado:</label>
      <pre id="settingsResult"></pre>
    </div>
  </section>

  <!-- Sección de Categorías -->
  <section id="categories-section">
    <h2>Categorías</h2>
    
    <div class="form-group">
      <label for="categoryName">Nombre:</label>
      <input type="text" id="categoryName" placeholder="Comida" />
    </div>
    
    <div class="form-group">
      <label for="categoryIcon">Icono:</label>
      <input type="text" id="categoryIcon" placeholder="restaurant" />
    </div>
    
    <div class="form-group">
      <label for="categoryType">Tipo:</label>
      <select id="categoryType">
        <option value="need">Necesidad</option>
        <option value="want">Deseo</option>
        <option value="save">Ahorro</option>
      </select>
    </div>
    
    <button onclick="getCategories()">Obtener Categorías</button>
    <button onclick="createCategory()">Crear Categoría</button>
    
    <div class="form-group">
      <label for="categoryId">ID Categoría:</label>
      <input type="number" id="categoryId" placeholder="1" />
    </div>
    
    <button onclick="getCategory()">Obtener Categoría</button>
    <button onclick="updateCategory()">Actualizar Categoría</button>
    <button onclick="deleteCategory()">Eliminar Categoría</button>
    
    <div class="form-group">
      <label>Resultado:</label>
      <pre id="categoriesResult"></pre>
    </div>
  </section>

  <!-- Sección de Transacciones -->
  <section id="transactions-section">
    <h2>Transacciones</h2>
    
    <div class="form-group">
      <label for="transactionAmount">Monto:</label>
      <input type="number" step="0.01" id="transactionAmount" placeholder="100.50" />
    </div>
    
    <div class="form-group">
      <label for="transactionDescription">Descripción:</label>
      <input type="text" id="transactionDescription" placeholder="Compra en supermercado" />
    </div>
    
    <div class="form-group">
      <label for="transactionDate">Fecha:</label>
      <input type="date" id="transactionDate" />
    </div>
    
    <div class="form-group">
      <label for="transactionKind">Tipo:</label>
      <select id="transactionKind">
        <option value="income">Ingreso</option>
        <option value="expense">Gasto</option>
      </select>
    </div>
    
    <div class="form-group">
      <label for="transactionCategoryId">ID Categoría (opcional):</label>
      <input type="number" id="transactionCategoryId" placeholder="1" />
    </div>
    
    <button onclick="getTransactions()">Obtener Transacciones</button>
    <button onclick="createTransaction()">Crear Transacción</button>
    
    <div class="form-group">
      <label for="transactionId">ID Transacción:</label>
      <input type="number" id="transactionId" placeholder="1" />
    </div>
    
    <button onclick="getTransaction()">Obtener Transacción</button>
    <button onclick="updateTransaction()">Actualizar Transacción</button>
    <button onclick="deleteTransaction()">Eliminar Transacción</button>
    <button onclick="getTransactionsSummary()">Resumen Mensual</button>
    
    <div class="form-group">
      <label>Resultado:</label>
      <pre id="transactionsResult"></pre>
    </div>
  </section>

  <!-- Sección de Historial -->
  <section id="history-section">
    <h2>Historial</h2>
    
    <button onclick="getMonthlyHistory()">Obtener Historial Mensual</button>
    <button onclick="getYearlyHistory()">Obtener Historial Anual</button>
    
    <div class="form-group">
      <label>Resultado:</label>
      <pre id="historyResult"></pre>
    </div>
  </section>

  <script>
    const API_URL = 'http://127.0.0.1:5000';
    let currentUser = null;

    // Helper function to display results
    function displayResult(elementId, data, isSuccess = true) {
      const resultElement = document.getElementById(elementId);
      resultElement.innerHTML = JSON.stringify(data, null, 2);
      resultElement.className = isSuccess ? 'success' : 'error';
    }

    // Helper function for API calls
    async function apiCall(endpoint, method = 'GET', body = null, needsAuth = true) {
      const options = {
        method,
        credentials: 'include',
        headers: {
          'Content-Type': 'application/json'
        }
      };

      if (body) {
        options.body = JSON.stringify(body);
      }

      try {
        const res = await fetch(`${API_URL}${endpoint}`, options);
        
        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }

        const data = await res.json();
        return data;
      } catch (error) {
        console.error('Error in API call:', error);
        return { error: error.message };
      }
    }

    // Authentication functions
    async function login() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;

      const data = await apiCall('/login', 'POST', { email, password }, false);
      displayResult('authResult', data, !data.error);
      
      if (!data.error) {
        currentUser = data.user || { id: data.user_id };
      }
    }

    async function checkAuth() {
      const data = await apiCall('/check-auth');
      displayResult('authResult', data, !data.error);
      
      if (data.logged_in) {
        currentUser = { id: data.user_id };
      } else {
        currentUser = null;
      }
    }

    async function logout() {
      const data = await apiCall('/logout', 'POST');
      displayResult('authResult', data, !data.error);
      currentUser = null;
    }

    async function getProfile() {
      const data = await apiCall('/profile');
      displayResult('authResult', data, !data.error);
      
      if (!data.error) {
        currentUser = data;
      }
    }

    async function checkEmail() {
      const email = document.getElementById('checkEmail').value;
      const data = await apiCall('/check-email', 'POST', { email }, false);
      displayResult('authResult', data, !data.error);
    }
    
    async function checkUsername() {
      const username = document.getElementById('checkUsername').value;
      const data = await apiCall('/check-username', 'POST', { username }, false);
      displayResult('authResult', data, !data.error);
    }    

    // User settings functions
    async function getSettings() {
      const data = await apiCall('/settings');
      displayResult('settingsResult', data, !data.error);
      
      if (!data.error && data.currency) {
        document.getElementById('currency').value = data.currency;
      }
    }

    async function updateSettings() {
      const currency = document.getElementById('currency').value;
      const data = await apiCall('/settings', 'PUT', { currency });
      displayResult('settingsResult', data, !data.error);
    }

    // Categories functions
    async function getCategories() {
      const data = await apiCall('/categories');
      displayResult('categoriesResult', data, !data.error);
    }

    async function createCategory() {
      const name = document.getElementById('categoryName').value;
      const icon = document.getElementById('categoryIcon').value;
      const type = document.getElementById('categoryType').value;
      
      const data = await apiCall('/categories', 'POST', { name, icon, type });
      displayResult('categoriesResult', data, !data.error);
    }

    async function getCategory() {
      const categoryId = document.getElementById('categoryId').value;
      const data = await apiCall(`/categories/${categoryId}`);
      displayResult('categoriesResult', data, !data.error);
    }

    async function updateCategory() {
      const categoryId = document.getElementById('categoryId').value;
      const name = document.getElementById('categoryName').value;
      const icon = document.getElementById('categoryIcon').value;
      const type = document.getElementById('categoryType').value;
      
      const data = await apiCall(`/categories/${categoryId}`, 'PUT', { name, icon, type });
      displayResult('categoriesResult', data, !data.error);
    }

    async function deleteCategory() {
      const categoryId = document.getElementById('categoryId').value;
      const data = await apiCall(`/categories/${categoryId}`, 'DELETE');
      displayResult('categoriesResult', data, !data.error);
    }

    // Transactions functions
    async function getTransactions() {
      const data = await apiCall('/transactions');
      displayResult('transactionsResult', data, !data.error);
    }

    async function createTransaction() {
      const amount = parseFloat(document.getElementById('transactionAmount').value);
      const description = document.getElementById('transactionDescription').value;
      const date = document.getElementById('transactionDate').value || new Date().toISOString().split('T')[0];
      const kind = document.getElementById('transactionKind').value;
      const categoryId = document.getElementById('transactionCategoryId').value;
      
      const body = { 
        amount, 
        description, 
        date,
        kind
      };
      
      if (categoryId) body.category_id = parseInt(categoryId);
      
      const data = await apiCall('/transactions', 'POST', body);
      displayResult('transactionsResult', data, !data.error);
    }

    async function getTransaction() {
      const transactionId = document.getElementById('transactionId').value;
      const data = await apiCall(`/transactions/${transactionId}`);
      displayResult('transactionsResult', data, !data.error);
    }

    async function updateTransaction() {
      const transactionId = document.getElementById('transactionId').value;
      const amount = parseFloat(document.getElementById('transactionAmount').value);
      const description = document.getElementById('transactionDescription').value;
      const date = document.getElementById('transactionDate').value;
      const kind = document.getElementById('transactionKind').value;
      const categoryId = document.getElementById('transactionCategoryId').value;
      
      const body = {};
      if (amount) body.amount = amount;
      if (description) body.description = description;
      if (date) body.date = date;
      if (kind) body.kind = kind;
      if (categoryId) body.category_id = parseInt(categoryId);
      
      const data = await apiCall(`/transactions/${transactionId}`, 'PUT', body);
      displayResult('transactionsResult', data, !data.error);
    }

    async function deleteTransaction() {
      const transactionId = document.getElementById('transactionId').value;
      const data = await apiCall(`/transactions/${transactionId}`, 'DELETE');
      displayResult('transactionsResult', data, !data.error);
    }

    async function getTransactionsSummary() {
      const data = await apiCall('/transactions/summary');
      displayResult('transactionsResult', data, !data.error);
    }

    // History functions
    async function getMonthlyHistory() {
      const data = await apiCall('/history/monthly');
      displayResult('historyResult', data, !data.error);
    }

    async function getYearlyHistory() {
      const data = await apiCall('/history/yearly');
      displayResult('historyResult', data, !data.error);
    }

    // Initialize date field with today's date
    document.getElementById('transactionDate').value = new Date().toISOString().split('T')[0];
  </script>
</body>
</html>